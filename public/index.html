<!DOCTYPE html>
<html>
  <head>
    <title>App 0.0.0</title>
    <link rel="stylesheet" href="style.css">
    <script src="react.js"></script>
    <script src="react-dom.js"></script>
    <script src="https://npmcdn.com/babel-core@5.8.38/browser.min.js"></script>
    <script src="https://npmcdn.com/react-router/umd/ReactRouter.min.js"></script>
  </head>
  <body>
    <div id = root></div> 
    <script type="text/babel">
    /* temp
    */
    var Router = ReactRouter.Router;
    var Route = ReactRouter.Route;
    var Link = ReactRouter.Link;
    var IndexLink = ReactRouter.IndexLink;
    var browserHistory = ReactRouter.browserHistory;
    var IndexRoute = ReactRouter.IndexRoute;

    class App extends React.Component {
      constructor(props) {
        super(props);
        this.pish = this.pish.bind(this);
      }

      pish() {
        browserHistory.push('/userdata');
      }

      render () {
        return<div>
                <h1 id="title"> App 0.0.0 </h1>
                <h2>You see this? This... is my BOOMSTICK!</h2>
                <ul className = "links">
                  <li><IndexLink to="/signup" activeClassName="linkActive">Signup</IndexLink></li>
                  <li><IndexLink to="/login" activeClassName="linkActive">Login</IndexLink></li>
                  <li><IndexLink to="/about" activeClassName="linkActive">About</IndexLink></li>
                </ul>
                {this.props.children}
              </div>
      }
    }

    class About extends React.Component {
      render() {
        return <div>
                Â© Rumata Estorskij, 2016.
              </div>
      }
    }

    class Signup extends React.Component {
      constructor(props) {
        super(props);
        this.signUp = this.signUp.bind(this);
      }

      fieldOnFocus () {
        slogin.value = '';
        spassword.value = '';
        swarn.innerHTML = '';
      }

      signUp() {
        let reqParams = {
          method: 'POST',
          headers: {  
            "Content-type": "application/x-www-form-urlencoded; charset=UTF-8"  
          },  
          body: 'login=' + encodeURIComponent(slogin.value) +
          '&password=' + encodeURIComponent(spassword.value)
        }

        fetch('/api/signup', reqParams)
          .then(res => res.json())
          .then(res => {
            if (res.error) {
              swarn.innerHTML = res.error; 
              return;
            }
            sOk.innerHTML = `Welcome aboard, ${res.login}! You may want to login.`                     
          })
          .catch(console.log);
      }

      render() {
        return <div>
                <input id="slogin" onFocus={this.fieldOnFocus}/>
                <input type="password" id="spassword"/>
                <p><button id = "signupBtn" onClick = {this.signUp}>Sign up</button></p>         
                <div id="swarn" className ="warn"></div>  
                <div id="sOk"></div>    
              </div>
      }
    }

    class Login extends React.Component {
      constructor(props) {
        super(props);
        this.logIn = this.logIn.bind(this);
      }

      logIn () {
        let reqParams = {
          method: 'POST',
          headers: {  
            "Content-type": "application/x-www-form-urlencoded; charset=UTF-8"  
          },  
          body: 'login=' + encodeURIComponent(login.value) +
          '&password=' + encodeURIComponent(password.value),
          credentials: 'include'
        }

        fetch('/api/login', reqParams)
          .then(res => res.json())
          .then(res => {
            if (res.error) {
              lwarn.innerHTML = res.error; 
              return;
            }
            browserHistory.push(`/userdata/${res.login}`);                    
          })
          .catch(console.log);
      }

      fieldOnFocus () {
        login.value = '';
        password.value = '';
        lwarn.innerHTML = '';
      }

      render () {
        return <div>
                <p>If you are already registered, you can login.</p>     
                <input id="login"/>
                <input type="password" id="password"/>
                <p><button id = "loginBtn" onClick={this.logIn}>Log in</button></p>              
                <div id="lwarn" className ="warn"></div>    
              </div>
      }
    }

    class NotFound extends React.Component {
      render() {
        return <div>
              404 Not Found
              </div>
      }
    }

    class Userdata extends React.Component {
      constructor(props) {
        super(props);
        this.state = {projects: []};
        this.addProj = this.addProj.bind(this);
      }

      chooseProj(e) {
        e.target.className = 'chosen';  
      }

      addProj () {
        let reqParams = {
          method: 'POST',
          headers: {  
            "Content-type": "application/x-www-form-urlencoded; charset=UTF-8"  
          },  
          body: 'project=' + encodeURIComponent(field.value),
          credentials: 'include'
        }
        fetch(`/api/userdata/${this.props.routeParams.login}`, reqParams)
          .then(res => res.json())
          .then(res => {
            if (!res.error) {
              return res._id;
            }
          })
          .then(_id => {
            this.setState( {projects: [...this.state.projects, 
            {name: field.value, _id: _id}]} );
          })
          .catch(console.log);        
      }

      componentDidMount () {
        let reqParams = {
          method: 'GET',
          headers: {  
            "Content-type": "application/x-www-form-urlencoded; charset=UTF-8"  
          },
          credentials: 'include'
        } 
        fetch(`/api/userdata/${this.props.routeParams.login}`, reqParams)
          .then(res => res.json())
          .then(res => {
            console.log(res);
            if (!res.error) {
              res.map(elem => {
                this.setState( {projects: [...this.state.projects, 
                {name: elem.name, _id: elem._id}]} );
              })
              return;
            }
              return console.log(res.error);
          })
          .catch(console.log);
      }

      render () {
        let projects = this.state.projects;
        return <div>
                <input type ="text" id="field"/>
                <button onClick={this.addProj}>Add project</button>
                <ol>
                  {projects.map((el,i) => {
                    return <li key={i} id={el._id} onClick={this.chooseProj}> {el.name} </li>;
                  })}
                </ol>
              </div>
      }
    }

    ReactDOM.render((
      <Router history={browserHistory}>
        <Route path="/" component={App}>
          <Route path="/userdata/:login" component={Userdata}/>
          <Route path="/signup" component={Signup}/>
          <Route path="/login" component={Login}/>
          <Route path="/about" component={About}/>
        </Route>
        <Route path="*" component={NotFound}>
        </Route>
      </Router>
    ), document.getElementById('root'));
  </script>
</body>
</html>